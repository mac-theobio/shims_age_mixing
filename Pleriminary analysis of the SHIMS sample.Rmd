---
title: \textbf{Supplementary File 1:}
subtitle: \textbf{A preliminary analysis of the random 5\% of the SHIMS sample}
author: "E. Dominic,  R. Beauclair, J. Dushoff, W. Delva"
#date: "08 September 2017"
output: pdf_document
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(tidyverse)
library(ordinal)    #for cumulative link mixed models
library(splines)    #or splines in models
library(survival)   #for cox ph model
library(effects)    #to do effects plots
library(cowplot)    #plot_grid
library(dotwhisker) #make dot whisker plots
library(broom)      #convert objects into tidy data frame: tidy()
library(visreg)     #getting "contrast" hazard ratios
library(nlme)       #fitting non linear mixed effects models
#install_github("baptiste/egg")
library(egg)

setwd("C:/Users/Emanuel/Desktop/shims_age_mixing")
#setwd("/Users/emanuel/Documents/shims_age_mixing")
source("Functions_for_SHIMS_study.R")
load("T1.agemix.Rdata")

```

```{r TIDY_DATAFRAME, echo=FALSE}
# ===================
# Tidy the dataframe 
# ===================
# tidy the data frame for age mixing analysis
T1.agemixing <- T1.agemix %>% transmute(Uid,
                                        Gender,
                                        Age.res.p1,
                                        Age.res.p2,
                                        Age.res.p3,
                                        Partner.age.p1,
                                        Partner.age.p2,
                                        Partner.age.p3)

setDT(T1.agemixing) #convert to a data.table for easy manipulation

DT.Agemix = T1.agemixing %>% melt( measure = patterns("^Age.res", "^Partner.age"),
                                   value.name = c("Age.participant", "Partner.age"),
                                   variable.name = "Partner")

DT.Agemix.men <- na.exclude(DT.Agemix[which(Gender == "Male" & Age.participant >= 15),])
DT.Agemix.men$Age.participant <- DT.Agemix.men$Age.participant - 15

# We want to tidy the data frame by subsetting and converting it 
# to long format so that each row represents a relationship.

T1.reldata <- T1.agemix %>% transmute(Uid,
                                      Gender,
                                      No.partners,
                                      Age.res.p1,
                                      Age.res.p2,
                                      Age.res.p3,
                                      Age.diff.p1,
                                      Age.diff.p2,
                                      Age.diff.p3,
                                      Condom.freq.p1,
                                      Condom.freq.p2,
                                      Condom.freq.p3,
                                      Sex.freq.p1,
                                      Sex.freq.p2,
                                      Sex.freq.p3,
                                      Partner.type.p1,
                                      Partner.type.p2,
                                      Partner.type.p3,
                                      Rel.dur.p1,
                                      Rel.dur.p2,
                                      Rel.dur.p3,
                                      Rel.ended.p1,
                                      Rel.ended.p2,
                                      Rel.ended.p3,
                                      Money.gifts.p1,
                                      Money.gifts.p2,
                                      Money.gifts.p3)
# code REF as NA
T1.reldata[T1.reldata == "REF"] <- NA

setDT(T1.reldata) #convert to a data.table for easy manipulation

DT.reldata <-  T1.reldata %>% 
  melt(measure = patterns("^Age.res", "^Age.diff",
                          "^Condom.freq", "^Sex.freq",
                          "^Partner.type", "^Rel.dur",
                          "^Rel.ended", "^Money.gifts"), 
       value.name = c("Age.participant", "Age.difference",
                      "Condom.frequency", "Sex.frequency",
                      "Partner.type", "Relationship.dur",
                      "Rel.ended", "Money.gifts"),  
      variable.name = "Partner"
        )


# ===========================================================
# Removing respondents who did not report relationship 1,2,3
# ===========================================================

DT.rel.men <- na.exclude(subset(DT.reldata, Gender == "Male" & Age.participant >= 15))
#DT.rel.men <- na.exclude(subset(DT.reldata, Gender == "Male"))


# ordering levels
freqlevels = c("never","sometimes","always")
sexlevels = c("1","between 2-5","between 6-10","more than 10")
partlevels = c("husband/wife","regular partner","casual partner")

DT.reldata.men <- DT.rel.men %>% 
  transmute(Uid = as.factor(Uid),
            #Gender,
            No.partners,
            Partner,
            Age.participant,
            Age.difference,
            Relationship.dur,
            Rel.ended = as.factor(Rel.ended),
            Condom.frequency = ordered(Condom.frequency, levels = freqlevels),
            Sex.frequency = ordered(Sex.frequency, levels = sexlevels),
            Partner.type = ordered(Partner.type, levels = partlevels),
            Money.gifts = ordered(Money.gifts, levels = freqlevels)
  )
  
#head(DT.reldata.men)
```

# Background

Age mixing in sexual relationships refers to how men and women choose their sexual partners with regards to age. Several studies have been conducted to investigate the associations between partner age differences in sexual relationships and sexual risk behaviours, HIV status, and HIV acquisition risk (Beauclair et al., 2016; Harling et al., 2014; Gregson et al., 2002; Kelly et al., 2003, Schaefer et al., 2017). However, the evidence for increased individual level risk is mixed, with some studies showing a positive association between relationship age differences and HIV prevalence (Gregson et al., 2002; Kelly et al., 2003), while other studies that have measured HIV incidence have not found any clear association (Harling et al., 2014; Street et al., 2015).

The research question we intend to answer is whether there exists associations between age differences in relationships and relationship characteristics---condom use, sex frequency, partner type and relationship duration---that have previously been found to have a potential relationship with HIV risk. Using SHIMS baseline survey data, our objective is to investigate:

1. The relationship between partner age and participant age 
2. The relationship between condom use and age differences
3. The relationship between sex frequency and age differences
4. The relationship between partner type and age differences
5. The relationship between relationship duration and age differences

# Methods

We used the 5% random subset of the SHIMS baseline survey male data in the analyses. We computed the age of the male participants when they started relationships with each partner and excluded those male participants whose age was less than 15 years. We had a total of 230 relationships that were reported by the male participants. Each row in the dataset represents a relationship. 

## Statistical Analysis

Our analyses focused on:

1. relationship between the participant age and the partner's age
2. four relationship characteristics that have previously been found to have a potential relationship with HIV risk:
    - condom use (ordinal; with levels "never", "sometimes", "always")
    - sex frequency (ordinal; with levels "1", "between 2-5", "between 6-10", "more than 10")
    - partner type (ordinal; with levels "husband/wife", "regular partner", "casual partner")
    - relationship duration (continuous, months)

Age difference was calculated by subtracting the female partner's age from the male partner's age (negative age difference implies that the woman is older than the man). The relationship duration was calculated by getting the difference between when the relationship began and when it ended. The relationships that were ongoing during the survey time and thus their end date was indicated as the enumeration date were denoted with an indicator variable. These ongoing relationships had right-censored relationship durations.

For starters, we wanted to investigate if the age of a participant had an effect on the age of the partner. We constructed a linear mixed effects model with a random intercept for each participant. To investigate the relationship between age difference and relationship characteristics, we created cumulative link mixed models treating condom use, sex frequency and partner type as outcome variables and the participant unique id as a random effect. We chose multilevel modelling so as to take into account population structure and dependencies. 

Finally, to assess the relationship between relationship duration and age difference, we constructed a Cox Proportional Hazard model since the relationship duration in the SHIMS dataset is right censored.




```{r AGEMIX_MODEL, echo=FALSE}
model <- lme(Partner.age~Age.participant,
             data = DT.Agemix.men,
             method = "REML",
             weights = varPower(value = 0.5, form = ~Age.participant + 1),
             random = ~1|Uid)

#summary(model)
```

```{r CONDOM_MODEL, echo=FALSE}
# Part I: CONDOM FREQUENCY

# (a) Effect of age difference on condom frequency with participant as random
# effect
# (b) Effect of age difference, age of participant and number of partners on 
# condom frequency

Condmod.1 <- clmm(Condom.frequency ~ ns(Age.difference,df = 4) + (1|Uid),
                data = DT.reldata.men,
                Hess = TRUE,
                nAGQ = 7)

#summary(Condmod.1)

Condmod.2 <- clmm(Condom.frequency ~ ns(Age.difference,df = 4) + 
                    ns(Age.participant,df = 4) +
                    #ns(Age.difference,df = 4) * ns(Age.participant,df = 4)  + 
                    No.partners + 
                    (1|Uid),
                  data = DT.reldata.men,
                  Hess = TRUE,
                  nAGQ = 7)

# the interaction term: too many parameters (26) which makes model complicated to interpret
# and may loose meaning

#summary(Condmod.2)

```

```{r SEX_MODEL, echo=FALSE}
# Part II: SEX FREQUENCY

# (a) Effect of age difference on sex frequency with participant as random effect
# (b) Effect of age difference, age of participant and number of partners on sex 
# frequency with participant as random effect

Sexmod.1 <- clmm(Sex.frequency ~ ns(Age.difference,df = 4) + (1|Uid),
                data = DT.reldata.men,
                Hess = TRUE,
                nAGQ = 7)

#summary(Sexmod.1)

Sexmod.2 <- clmm(Sex.frequency ~ ns(Age.difference,df = 4) + ns(Age.participant,df = 4) +No.partners + (1|Uid),
                 data = DT.reldata.men,
                 Hess = TRUE,
                 nAGQ = 12)

#summary(Sexmod.2)
```

```{r PARTNER_MODEL, echo=FALSE}
# Part III: PARTNER TYPE

# (a) Effect of age difference on partner type with participant as random effect
# (b) Effect of age difference, age of participant and number of partners on partner type
# with participant as random effect

Partmod.1 <- clmm(Partner.type ~ ns(Age.difference,df = 4) + (1|Uid),
                data = DT.reldata.men,
                Hess = TRUE,
                nAGQ = 7)

#summary(Partmod.1)

Partmod.2 <- clmm(Partner.type ~ ns(Age.difference,df = 4) + 
                    ns(Age.participant,df = 4) +
                    #ns(Age.difference,df = 4) * ns(Age.participant, ds = 4) + 
                    No.partners + 
                    (1|Uid),
                  data = DT.reldata.men,
                  Hess = TRUE,
                  nAGQ = 7)

#summary(Partmod.2)

```

```{r RELATIONSHIP_MODEL, echo=FALSE}
# Part V: RELATIONSHIP DURATION

# (a) Effect of age difference on relationship duration with participant as random effect
# (b) Effect of age difference, age of participant and number of partners on relationship 
# duration with participant as random effect
#-fit the cox model
# censoring status, 0=censored(relationship not ended) , 1= observed(relationship ended)

Reldurmod.1 <- coxph(Surv(Relationship.dur, Rel.ended == 1) ~ ns(Age.difference, df = 4),
                     data = DT.reldata.men)

#summary(Reldurmod.1)

Reldurmod.2 <- coxph(Surv(Relationship.dur, Rel.ended == 1) ~ ns(Age.difference, df = 4) +
                       ns(Age.participant, df = 4) +
                       #ns(Age.difference,df = 4) * ns(Age.participant, ds = 4)+
                       No.partners,
                     data = DT.reldata.men)

#summary(Reldurmod.2)
```

```{r TIDY_AGEMIX_MODEL, echo=FALSE}
# Extract slope = Beta-coefficent of the fixed effect from model
slope <- model$coefficients$fixed[2]

# Extract population intercepts = expected age of partner for a man starting a relationship at age 15
intercept <- model$coefficients$fixed[1]

# Extract power coefficient of variance function
power <- (attributes(model$apVar)$Pars["varStruct.power"])
power.lowerbound <- intervals(model)$varStruct[,1]
power.upperbound <- intervals(model)$varStruct[,3]

# Extract between-individual variance
between.var <- VarCorr(model)[1] %>% as.numeric()

# Extract residual variance = within-individual variance
within.var <- VarCorr(model)[2] %>% as.numeric()

```

```{r TIDY_CONDOM_MODEL_OUTPUTS, echo=FALSE, message=FALSE, warning=FALSE}
# Part I: CONDOM FREQUENCY

# (a) for univariate model
tidycond.1 <- Effect("Age.difference", Condmod.1, 
                     xlevels = list(Age.difference = 50)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.difference) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = freqlevels))%>%
  spread(fit, value) 

# (b) for multivariate model

# (i) Age difference effect
tidycond.2a <- Effect("Age.difference", Condmod.2, 
                      xlevels = list(Age.difference = 50)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.difference) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = freqlevels))%>%
  spread(fit, value)
# (ii) Age of participant effect
tidycond.2b <- Effect("Age.participant", Condmod.2, 
                      xlevels = list(Age.participant = 40)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.participant) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = freqlevels))%>%
  spread(fit, value) 

#(c) Predicted effects on condom frequency

#(i) for univariate
tidycond.3 <- OrdPred(Condmod.1,"Age.difference",DT.reldata.men)

#(ii) for multivarite
# Age difference
tidycond.3a <- OrdPred(Condmod.2,"Age.difference",DT.reldata.men)

# Age participant
tidycond.3b <- OrdPred(Condmod.2,"Age.participant",DT.reldata.men)


```

```{r TIDY_SEX_MODEL_OUTPUTS, eval= TRUE, echo=FALSE, message=FALSE, warning=FALSE}
# Part II: SEX FREQUENCY

# (a) for univariate model
tidysf.1 <- Effect("Age.difference", Sexmod.1, 
                   xlevels = list(Age.difference = 50)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.difference) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("X", "", cond)) %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = c("1","between.2.5","between.6.10","more.than.10"))%>%
           plyr::mapvalues(from = c("1","between.2.5","between.6.10","more.than.10"),
                           to = sexlevels)) %>% 
  spread(fit, value) 

# (b) for multivariate model

# (i) Age difference effect

tidysf.2a <- Effect("Age.difference", Sexmod.2, 
                    xlevels = list(Age.difference = 50)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.difference) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("X", "", cond)) %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = c("1","between.2.5","between.6.10","more.than.10"))%>%
           plyr::mapvalues(from = c("1","between.2.5","between.6.10","more.than.10"),
                           to = sexlevels)) %>% 
  spread(fit, value) 

# (ii) Age of participant effect

tidysf.2b <- Effect("Age.participant", Sexmod.2, 
                    xlevels = list(Age.participant = 40)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.participant) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("X", "", cond)) %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = c("1","between.2.5","between.6.10","more.than.10"))%>%
           plyr::mapvalues(from = c("1","between.2.5","between.6.10","more.than.10"),
                           to = sexlevels)) %>% 
  spread(fit, value) 

#(c) Predicted effects on sex frequency

#(i) for univariate
tidysex.3 <-  OrdPred(Sexmod.1,"Age.difference",DT.reldata.men)

#(ii) for multivarite
# Age difference

tidysex.3a <-  OrdPred(Sexmod.2,"Age.difference",DT.reldata.men)

# Age of participant
tidysex.3b <-  OrdPred(Sexmod.2,"Age.participant",DT.reldata.men)


```

```{r TIDY_PARTNER_MODEL_OUTPUTS, echo=FALSE, message=FALSE, warning=FALSE}
# Part III: PARTNER TYPE

# (a) for univariate model
tidypart.1 <- Effect("Age.difference", Partmod.1, 
                     xlevels = list(Age.difference = 50)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.difference) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = c("husband.wife","regular.partner","casual.partner"))%>%
           plyr::mapvalues(from = c("husband.wife","regular.partner","casual.partner"),
                           to = partlevels)) %>% 
  spread(fit, value) 

# (b) for multivariate model

# (i) Age difference effect
tidypart.2a <- Effect("Age.difference", Partmod.2, 
                      xlevels = list(Age.difference = 50)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.difference) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = c("husband.wife","regular.partner","casual.partner"))%>%
           plyr::mapvalues(from = c("husband.wife","regular.partner","casual.partner"),
                           to = partlevels)) %>% 
  spread(fit, value) 

# (ii) Age of participant effect
tidypart.2b <- Effect("Age.participant", Partmod.2, 
                      xlevels = list(Age.participant = 40)) %>%
  data.frame() %>%
  select(-matches("logit.")) %>%
  gather(var, value, - Age.participant) %>%
  separate(var, c("fit", "cond"), extra = "merge") %>%
  mutate(cond = gsub("prob.", "", cond) %>%
           ordered(levels = c("husband.wife","regular.partner","casual.partner"))%>%
           plyr::mapvalues(from = c("husband.wife","regular.partner","casual.partner"),
                           to = partlevels)) %>% 
  spread(fit, value) 

#(c) Predicted effects on partner type

#(i) for univariate

tidypart.3 <- OrdPred(Partmod.1,"Age.difference", DT.reldata.men)

#(ii) for multivarite
# Age difference

tidypart.3a <- OrdPred(Partmod.2,"Age.difference", DT.reldata.men)

# Age of participant
tidypart.3b <- OrdPred(Partmod.2,"Age.participant", DT.reldata.men)


```

```{r TIDY_RELATIONSHIP_MODEL_OUTPUTS, echo=FALSE, warning=FALSE, message=FALSE,include=FALSE}
# Part V: RELATIONSHIP DURATION

# Obtain survival times at different percentiles of agedif
# percentiles <- quantile(DT.reldata.men$Age.difference, prob = c(.025, .25, .5, .75, .975))
percentiles <- c(-4.83526999316473,1.33561175666439,3.98222829801777,7.33082706766918,25.6226930963773)
# compute expected survival probabilities at different times and tidy the data frame

tidyreldur.1 <- survexp(~ Age.difference, 
                       data = DT.reldata.men, 
                       ratetable = Reldurmod.1) %>%
  tidy() %>%
  select(-matches("n.risk")) %>%
  gather(var, value, -time) %>%
  mutate(var = gsub("surv.Age.difference\\.", "", var),
         Age.difference = gsub("^\\D", "-", var) %>%
           as.numeric()) %>%
  select(-var) %>%
  filter(Age.difference %in% percentiles) %>%
  mutate(Age.difference = factor(Age.difference, 
                         levels = percentiles,
                         labels = c("5yrs younger", 
                                    "1yr older", 
                                    "3yrs older",
                                    "7yrs older",
                                    "25yrs older")))

tidyreldur.2 <- visreg(Reldurmod.1,
                       xvar = "Age.difference",
                       type = "contrast",
                       trans = exp) %$%
  data.frame(fit) %>%
  mutate(hr = visregFit,
         lwr = visregLwr,
         upr = visregUpr)

# (b) multivariate

tidyreldur.1a <- survexp(~ Age.difference, 
                        data = DT.reldata.men, 
                        ratetable = Reldurmod.2) %>%
  tidy() %>%
  select(-matches("n.risk")) %>%
  gather(var, value, -time) %>%
  mutate(var = gsub("surv.Age.difference\\.", "", var),
         Age.difference = gsub("^\\D", "-", var) %>%
           as.numeric()) %>%
  select(-var) %>%
  filter(Age.difference %in% percentiles) %>%
  mutate(Age.difference = factor(Age.difference, 
                                 levels = percentiles,
                                 labels = c("5yrs younger", 
                                            "1yr older", 
                                            "3yrs older",
                                            "7yrs older",
                                            "25yrs older")))
tidyreldur.2a <- visreg(Reldurmod.2,
                       xvar = "Age.difference",
                       type = "contrast",
                       trans = exp) %$%
  data.frame(fit) %>%
  mutate(hr = visregFit,
         lwr = visregLwr,
         upr = visregUpr)

```

# Results


```{r AGEMIX_PLOT, echo=FALSE, fig.align="center", fig.height=2.9,fig.width=5.9}
theme_set(theme_bw())
fixParam <- fixef(model)
ranParam <- ranef(model)
params <- ranParam[1]+fixParam[1]

Raw_data <- ggplot(DT.Agemix.men,aes(Age.participant,Partner.age)) +
  geom_jitter(size=3,color="black", width = 0.25, height = 0.25, alpha = 0.5) +
  xlab("Age") +
  ylab("Partner age") +
  scale_x_continuous(labels = function(x)x+15, breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text( size=9)) + 
  geom_abline(aes(intercept = fixParam[1],slope = fixParam[2],color = "Population average"), size = 1.25) +
  geom_abline(aes(intercept = 15,slope =1,color = "Diagonal (x = y)"), size = 1.25) +
  scale_colour_manual(name="Line Colour",
    values=c("Population average" = "#D95F02", "Diagonal (x = y)" ="#1B9E77")) 
print(Raw_data)

#ggplot2::ggsave("Raw_data.pdf")
# 
# subNum <- unique(DT.Agemix.men$Uid)
# 
# for(i in 1:length(subNum)){
#   Raw_data <- Raw_data + geom_abline(intercept = params[i,1],slope = fixParam[2],color ="lightskyblue2")
# }
# 
# Raw_data <- Raw_data + geom_abline(intercept = fixParam[1],slope = fixParam[2],color = "blue",size=1.5)
# print(Raw_data)
```
**Figure 1. Plot of partner age against participant age.**

\vspace{4mm} 

##### Highlights from Figure 1:

- A cone-like shape showing that the variability of the partner age widens as the age of the man increases.
- On average, men tend to choose younger sexual partners.
- The variation in age differences increases with the age of the man.

\vspace{1cm} 

```{r CONDOM_PLOTS, echo=FALSE, fig.align="center", fig.width=5.5, fig.height=5.5, fig.asp=1, warning=FALSE}
# Part I: CONDOM FREQUENCY
theme_set(theme_bw())
# (a) Univariate

cond.1a <- tidycond.1 %>%
  ggplot(aes(x = Age.difference, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age difference") +
  ylab("Probability") +
  scale_fill_brewer(name = "Condom use", 
                    palette = "Dark2")+
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text( size=9)) 

cond.pred.3 <- tidycond.3 %>%
  ggplot(aes(x = Age.difference, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age difference") +
  ylab("Condom use score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text( size=9)) 

plot_grid(cond.1a + theme(legend.position = "none"),
          get_legend(cond.1a),
          cond.pred.3,
          labels = c("(A)","","(B)"),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 2,
          align = "vh",
          rel_widths = c(1, 0.17))

# ggplot2::ggsave("Condom_use.pdf")
# grid.draw(ggarrange(cond.1a,
#                     cond.pred.3,
#                     ncol = 1))
```

**Figure 2. Results of cumulative-link mixed model with condom use as the response and age difference as the predictor.** In this model, age difference was a spline term. (A) Cumulative probability of condom use categories. (B) Predicted ordinal condom use score (scored as 0 for "never" up to 2 for "always"), with shaded areas representing the 95% confidence interval.

\vspace{4mm} 

##### Highlights from Figure 2:

- The probability of consistent condom use decreases as the age difference between the man and the partner increases.
- The overall condom use decreases as the age difference increases as shown in Panel (B).
- Patterns outside the age difference range of -5 years to 20 years  cannot be inferred clearly because of the large confidence intervals.

\vspace{1cm}

```{r CONDOM_PLOTS2, echo=FALSE, fig.align="center", fig.width=5.5, fig.height=7, fig.asp=1, warning=FALSE}
theme_set(theme_bw())
# (b) Multivariate

cond.2a <- tidycond.2a %>%
  ggplot(aes(x = Age.difference, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age difference") +
  ylab("Probability") +
  scale_fill_brewer(name = "Condom use", 
                    palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text( size=9)) 

cond.2b <- tidycond.2b %>%
  ggplot(aes(x = Age.participant, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age") +
  ylab("Probability") +
  scale_fill_brewer(name = "Condom use", 
                    palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text( size=9)) 

cond.pred.3a <- tidycond.3a %>%
  ggplot(aes(x = Age.difference, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age difference") +
  ylab("Condom Use Score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text( size=9)) 

cond.pred.3b <- tidycond.3b %>%
  ggplot(aes(x = Age.participant, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age") +
  ylab("Condom Use Score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text( size=9)) +
  ylim(0,2)

plot_grid(cond.2a + theme(legend.position = "none"),
          cond.2b + theme(legend.position = "none"),
          get_legend(cond.2a),
          cond.pred.3a + theme(legend.position = "none"),
          cond.pred.3b + theme(legend.position = "none"),
          NULL,
          labels = c("(A)", "(B)", "", "(C)", "(D)", ""),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 3,
          rel_widths = c(1, 1, 0.35))

# ggplot2::ggsave("Condom_use2.pdf")
# grid.draw(ggarrange(cond.2a,
#                     cond.2b,
#                     cond.pred.3a,
#                     cond.pred.3b,
#                     ncol = 2))
```
**Figure 3. Results of cumulative-link mixed model with condom use as the response and age difference as the predictor while controlling for age and the number of partners.** In this model, both age difference and age of participant were spline terms. (A) Cumulative probability of condom use for different age differences. (B) Cumulative probability of condom use for different age of participants. (C) Predicted effect of age difference on ordinal condom use score (scored as 0 for "never" up to 2 for "always"), with shaded areas representing the 95% confidence interval. (D) Predicted effect of age of participant on ordinal condom use score, with shaded areas representing the 95% confidence interval.

\vspace{4mm}

##### Highlights from Figure 3:

- When inferring for the region when the age difference is between -5 years and 20 years, we observe an increase in consistent condom use which peaks when the age difference is 10 years then it starts dropping.
- There is a notable peak in the probability of condom use when the age difference is around 10 years.
- Panel (B) shows that the probability of consistent condom use peaks when men are around 18 years old and then drops.

\vspace{1cm}

```{r SEX_PLOTS, echo=FALSE, eval=TRUE,fig.align="center", fig.width=5.5, fig.height=5.5, fig.asp=1, warning=FALSE}
# Part II: SEX FREQUENCY
theme_set(theme_bw())
# Effects plot for sex frequency model

# univariate
sex.1a <- tidysf.1 %>%
  ggplot(aes(x = Age.difference, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age difference") +
  ylab("Probability") +
  scale_fill_brewer(name = "Sex frequency", 
                    palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) 

sex.pred.3 <- tidysex.3 %>%
  ggplot(aes(x = Age.difference, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age difference") +
  ylab("Sex frequency score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) +
  ylim(0,3)


plot_grid(sex.1a + theme(legend.position = "none"),
          get_legend(sex.1a),
          sex.pred.3,
          labels = c("(A)","","(B)"),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 2,
          align = "v",
          rel_widths = c(1, 0.22))

# ggplot2::ggsave("Sex_frequency.pdf")
# grid.draw(ggarrange(sex.1a,
#                     sex.pred.3,
#                     ncol = 1))

```
**Figure 4. Results of cumulative-link mixed model with sex frequency as the response and age difference as the predictor.** In this model, age difference was a spline term. (A) Cumulative probability of sex frequency (in the last 6 months) categories. (B) Predicted effect of age difference on ordinal sex frequency score (scored as 0 for "1 time" up to 3 for "more than 10" times in the last six months), with shaded areas representing the 95% confidence interval.

\vspace{4mm}

##### Highlights from Figure 4:

- Sex frequency is highest when the man is 2 years younger than the partner and 17 years older than the partner.
- There is a general increase in sex frequency besides the drop observed when the age difference is 4 years.

\vspace{1cm}

```{r SEX_PLOTS2,eval=TRUE, echo=FALSE, fig.align="center", fig.width=5.5, fig.height=7, fig.asp=1, warning=FALSE}
theme_set(theme_bw())
# multivariate

sex.2a <- tidysf.2a %>%
  ggplot(aes(x = Age.difference, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age difference") +
  ylab("Probability") +
  scale_fill_brewer(name = "Sex Frequency", 
                    palette = "Dark2")  +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9))

sex.2b <- tidysf.2b %>%
  ggplot(aes(x = Age.participant, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age") +
  ylab("Probability") +
  scale_fill_brewer(name = "Sex Frequency", 
                    palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) 
  

sex.pred.3a <- tidysex.3a %>%
  ggplot(aes(x = Age.difference, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age difference") +
  ylab("Sex Frequency Score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) +
  ylim(0,3)


sex.pred.3b <- tidysex.3b %>%
  ggplot(aes(x = Age.participant, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age") +
  ylab("Sex Frequency Score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) +
  ylim(0,3)

plot_grid(sex.2a + theme(legend.position = "none"),
          sex.2b + theme(legend.position = "none"),
          get_legend(sex.2b),
          sex.pred.3a + theme(legend.position = "none"),
          sex.pred.3b + theme(legend.position = "none"),
          NULL,
          labels = c("(A)", "(B)", "", "(C)", "(D)", ""),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 3,
          rel_widths = c(2,2,0.85))

# ggplot2::ggsave("Sex_frequency2.pdf")
# grid.draw(ggarrange(sex.2a,
#                     sex.2b,
#                     sex.pred.3a,
#                     sex.pred.3b,
#                     ncol = 2))
```
**Figure 5. Results of cumulative-link mixed model with sex frequency as the response and age difference as the predictor while controlling for age and the number of partners.** In this model, both age difference and age of participant were spline terms. (A) Cumulative probability of sex frequency (in the last 6 months) for different age differences. (B) Cumulative probability of sex frequency for different age of participants. (C) Predicted effect of age difference on ordinal sex frequency score (scored as 0 for "1 time" up to 3 for "more than 10" times in the last six months), with shaded areas representing the 95% confidence interval. (D) Predicted effect of age of participant on ordinal sex frequency score, with shaded areas representing the 95% confidence interval.

\vspace{4mm}

##### Highlights from Figure 5:

- When we control for age and the number of partners, we observe a trend in Panel (A) which is similar to Figure 4a.
- There is a non-linear increase in sex frequency as the age of the man increases.
- Extreme values of age differences and age have large confidence intervals.

\vspace{1cm}

```{r PARTNER_PLOTS, echo=FALSE, fig.align="center", fig.width=5.5, fig.height=5.5, fig.asp=1, warning=FALSE}
# Part III: PARTNER TYPE
theme_set(theme_bw())
# Effects plot for partner type models

#univariate
part.1a <- tidypart.1 %>%
  ggplot(aes(x = Age.difference, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age difference") +
  ylab("Probability") +
  scale_fill_brewer(name = "Partner type", 
                    palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) 

part.pred.3 <- tidypart.3 %>% 
  ggplot(aes(x = Age.difference, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age difference") +
  ylab("Partner Type Score")+
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) 

plot_grid(part.1a + theme(legend.position = "none"),
          get_legend(part.1a),
          part.pred.3,
          labels = c("(A)","","(B)"),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 2,
          align = "v",
          rel_widths = c(1, 0.22))

# ggplot2::ggsave("Partner_type.pdf")
# grid.draw(ggarrange(part.1a,
#                     part.pred.3,
#                     ncol = 1))

```
**Figure 6. Results of cumulative-link mixed model with partner type as the response and age difference as the predictor.** In this model, age difference was a spline term. (A) Cumulative probability of partner type categories. (B) Predicted effect of age difference on ordinal partner type score (scored as 0 for "husband/wife" up to 2 for "casual partner"), with shaded areas representing the 95% confidence interval.

\vspace{4mm}

##### Highlights from Figure 6

- When the man is younger than the woman, the sexual partner mainly a casual partner in most of the sexual relationships.
- There is an increase in probability of the partner being a wife as the age difference increases.

\vspace{1cm}

```{r PARTNER_PLOTS2, echo=FALSE, fig.align="center", fig.width=5.5, fig.height=7, fig.asp=1, warning=FALSE}
theme_set(theme_bw())
#multivariate
part.2a <- tidypart.2a %>%
  ggplot(aes(x = Age.difference, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age difference") +
  ylab("Probability") +
  scale_fill_brewer(name = "Partner type", 
                    palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) 

part.2b <- tidypart.2b %>%
  ggplot(aes(x = Age.participant, y = prob, fill = cond)) +
  geom_area() +
  xlab("Age") +
  ylab("Probability") +
  scale_fill_brewer(name = "Partner type", 
                    palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9))

part.pred.3a <- tidypart.3a %>% 
  ggplot(aes(x = Age.difference, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age difference") +
  ylab("Partner Type Score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9))

part.pred.3b <- tidypart.3b %>% 
  ggplot(aes(x = Age.participant, y = fit)) +
  geom_line(size = 1, color = "#009E73") +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25,
              fill = "#009E73") +
  xlab("Age") +
  ylab("Partner Type Score") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9)) +
  theme(text=element_text(size=9)) +
  ylim(NA, 2)

plot_grid(part.2a + theme(legend.position = "none"),
          part.2b + theme(legend.position = "none"),
          get_legend(part.2b),
          part.pred.3a + theme(legend.position = "none"),
          part.pred.3b + theme(legend.position = "none"),
          NULL,
          labels = c("(A)", "(B)", "", "(C)", "(D)", ""),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 3,
          rel_widths = c(1, 1, 0.44))

# ggplot2::ggsave("Partner_type2.pdf")
# grid.draw(ggarrange(part.2a,
#                     part.2b,
#                     part.pred.3a,
#                     part.pred.3b,
#                     ncol = 2))
```
**Figure 7. Results of cumulative-link mixed model with partner type as the response and age difference as the predictor while controlling for age and the number of partners.** In this model, both age difference and age of participant were spline terms. (A) Cumulative probability of partner type for different age differences. (B) Cumulative probability of partner type for different age of participant. (C) Predicted effect of age difference on ordinal partner type score (scored as 0 for "husband/wife" up to 2 for "casual partner"), with shaded areas representing the 95% confidence interval. (D) Predicted effect of age of participant on ordinal partner type score, with shaded areas representing the 95% confidence interval.

\vspace{4mm}

##### Highlights from Figure 7

- The probability of a partner being a wife increases as the age difference between the man and the partner increases.
- Likewise, as the man grows old, the probability of the partner being a wife increases.
- Teenage men (less than 20 years) generally have casual partners.
- Extreme values of age differences and age have large confidence intervals.

\vspace{1cm}

```{r RELATIONSHIP_PLOTS, echo=FALSE, fig.align="center", fig.width=5.5, fig.height=5.5, fig.asp=1,warning=FALSE}
# Part V: RELATIONSHIP DURATION
theme_set(theme_bw())
# (a) univariate


rel.pred.1 <- tidyreldur.2 %>%
  ggplot(aes(x = Age.difference, y = hr)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25, 
              fill = "#009E73") +
  geom_line(size = 1, 
            color = "#009E73") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  xlab("Age difference") +
  ylab("HR (log)") +
  scale_y_log10() +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9))+
  theme(text=element_text(size=9)) 
  

reldur.1 <- tidyreldur.1 %>%
  ggplot(aes(x = time, 
             y = value)) +
  geom_line(aes(color = Age.difference), size = 1) +
  geom_hline(yintercept = 0.5, colour = "black", linetype = 2) + 
  xlab("Relationship duration (Weeks)") +
  ylab("Probability of survival") +
  scale_color_brewer(name = "Age difference", palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9))+
  theme(text=element_text(size=9)) 


plot_grid(rel.pred.1,
          NULL,
          reldur.1 + theme(legend.position = "none"),
          get_legend(reldur.1),
          labels = c("(A)","","(B)",""),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 2,
          align = "v",
          rel_widths = c(1, 0.22))

# ggplot2::ggsave("Relationship_dur.pdf")
# grid.draw(ggarrange(rel.pred.1,
#                     reldur.1,
#                     ncol = 1))
```
**Figure 8. Results of Cox Proportional Hazards Model with relationship duration as the response and age difference as the predictor.** In this model, age difference was a spline term. (A) Predicted HRs for age differences, with mean age difference (6.2 years) as the reference. (B) Expected survival curves for selected age differences.

\vspace{4mm}

##### Highlights from Figure 8

- The hazard of ending a relationship appears to be greater for relationships where the man is 6 years older or more although the confidence intervals include 1 suggesting that the difference is not significant. 
- When the age difference is between -5 years and 0 years, the hazard of ending a relationship is much lower.
- The relationship duration is shortest when the man is 25 years older than the partner and longest when the man is 1 year older than the partner.

\vspace{1cm}

```{r RELATIONSHIP_PLOTS2, echo=FALSE, fig.align="center", fig.width=5.5, fig.height=5.5, fig.asp=1,warning=FALSE}
theme_set(theme_bw())
# (b) multivariate


rel.pred.2 <- tidyreldur.2a %>%
  ggplot(aes(x = Age.difference, y = hr)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr),
              alpha = 0.25, 
              fill = "#009E73") +
  geom_line(size = 1, 
            color = "#009E73") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  xlab("Age difference") +
  ylab("HR (log)") +
  scale_y_log10() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9))+
  theme(text=element_text(size=9)) 


reldur.2 <- tidyreldur.1a %>%
  ggplot(aes(x = time, 
             y = value)) +
  geom_line(aes(color = Age.difference), size = 1) +
  geom_hline(yintercept = 0.5, colour = "black", linetype = 2) + 
  xlab("Relationship duration (Weeks)") +
  ylab("Probability of survival") +
  scale_color_brewer(name = "Age difference", palette = "Dark2") +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9))+
  theme(text=element_text(size=9)) 


plot_grid(rel.pred.2,
          NULL,
          reldur.2 + theme(legend.position = "none"),
          get_legend(reldur.2),
          labels = c("(A)","","(B)",""),
          label_size = 9,
          hjust = -0.2,
          vjust = 1,
          ncol = 2,
          align = "v",
          rel_widths = c(1, 0.22))

# ggplot2::ggsave("Relationship_dur2.pdf")
# grid.draw(ggarrange(rel.pred.2,
#                     reldur.2,
#                     ncol = 1))

```
**Figure 9. Results of Cox Proportional Hazards Model with relationship duration as the response and age difference as the predictor while controlling for age and the number of partners.** In this model, both age difference and age of participant were spline terms. (A) Predicted HRs for age differences, with mean (age difference = 6.2) as the reference. (B) Expected survival curves for selected age differences.

\vspace{4mm}

##### Highlights from Figure 9

-  The hazard of ending a relationship is greater for relationships where the man is younger than partner and lowest when the age difference is greater than 20 years. 
- The relationship durations is shortest when the man is 5 years younger than the partner and when longest when the man is 1 year older than the partner.

# References

Beauclair, R., Helleringer, S., Hens, N., & Delva, W. (2016). Age differences between sexual partners, behavioural and demographic correlates, and HIV infection on Likoma Island, Malawi. Scientific reports, 6.

Gregson, S., Nyamukapa, C. A., Garnett, G. P., Mason, P. R., Zhuwau, T., Cara?l, M., ... & Anderson, R. M. (2002). Sexual mixing patterns and sex-differentials in teenage exposure to HIV infection in rural Zimbabwe. The Lancet, 359 (9321), 1896-1903.

Harling, G., Newell, M.-L., Tanser, F., Kawachi, I., Subramanian, S., & Barnighausen, T. (2014). Do age-disparate relationships drive HIV incidence in young women? Evidence from a population cohort in rural KwaZulu-Natal, South Africa. Journal of acquired immune deficiency syndromes (1999), 443-451.

Kelly, R., Gray, R., Sewankambo, N., Serwadda, D., Wabwire-Mangen, F., Lutalo, T., & Wawer, M. (2003). Age differences in sexual partners and risk of HIV-1 infection in rural Uganda. JAIDS Journal of Acquired Immune Deficiency Syndromes, 32(4), 446-451.

Street, R. A., Reddy, T., & Ramjee, G. (2016). The generational effect on age disparate partnerships and the risk for human immunodeficiency virus and sexually transmitted infections acquisition. International journal of STD & AIDS, 27(9), 746-752.

Schaefer, R., Gregson, S., Eaton, J. W., Mugurungi, O., Rhead, R., Takaruza, A., ... & Nyamukapa, C. (2017). Age-disparate relationships and HIV incidence in adolescent girls and young women: evidence from Zimbabwe. AIDS (London, England), 31(10), 1461.
